<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Mr.heesong@gmail.com Song "><meta name=description content="mongoDB安装 参照：https://docs.mongodb.com/manual/tutorial/install-mongodb-o"><meta name=keywords content="js,javascript,nodejs,jquery,css,sass,gulp,html,git,java,hibernate,spring,maven,mysql,sql,linux,acm,架构,前端,后端,原创,编程,开发,算法,运维,云计算,网络,互联网,mongo集群,部署"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://blog.singasoong.top/posts/mongo_cluster_deployment/><title>高可用性的mongo集群搭建 :: Song's Blog</title><link rel=stylesheet href=/main.b78c3be9451dc4ca61ca377f3dc2cf2e6345a44c2bae46216a322ef366daa399.css integrity="sha256-t4w76UUdxMphyjd/PcLPLmNFpEwrrkYhajIu82bao5k="><link rel=stylesheet type=text/css href=/css/main.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="高可用性的mongo集群搭建"><meta itemprop=description content="mongoDB安装 参照：https://docs.mongodb.com/manual/tutorial/install-mongodb-o"><meta itemprop=datePublished content="2019-06-25T00:00:00+00:00"><meta itemprop=dateModified content="2019-06-25T00:00:00+00:00"><meta itemprop=wordCount content="2470"><meta itemprop=image content="https://blog.singasoong.top/"><meta itemprop=keywords content="mongo集群,部署,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.singasoong.top/"><meta name=twitter:title content="高可用性的mongo集群搭建"><meta name=twitter:description content="mongoDB安装 参照：https://docs.mongodb.com/manual/tutorial/install-mongodb-o"><meta property="og:title" content="高可用性的mongo集群搭建"><meta property="og:description" content="mongoDB安装 参照：https://docs.mongodb.com/manual/tutorial/install-mongodb-o"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.singasoong.top/posts/mongo_cluster_deployment/"><meta property="og:image" content="https://blog.singasoong.top/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-25T00:00:00+00:00"><meta property="article:modified_time" content="2019-06-25T00:00:00+00:00"><meta property="article:published_time" content="2019-06-25 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-17EFCQS4KZ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-17EFCQS4KZ")</script></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>rm -rf world</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://blog.singasoong.top/posts>Blog</a></li><li><a href=https://blog.singasoong.top/tags>Tag</a></li><li><a href=/search><svg t="1556783211810" class="search-box-icon" class="icon" style viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="2078" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style/></defs><path d="M981.39652054 920.86314525 704.56522859 644.0318533a366.65501012 366.65501012.0 10-61.73503038 65.64040943L917.55859375 984.40065827zM125.21726707 427.73393664a284.19142939 284.19142939.0 11283.89101562 284.19142939A284.49184317 284.49184317.0 01125.06706019 427.73393664z" fill p-id="2079" data-spm-anchor-id="a313x.7781069.0.i2"/></svg></a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><ol class=breadcrumb><li><a href=https://blog.singasoong.top/>Home</a></li><li><a href=https://blog.singasoong.top/posts/>Posts</a></li><li class=active><a href=https://blog.singasoong.top/posts/mongo_cluster_deployment/>高可用性的mongo集群搭建</a></li></ol><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes</p></div><article><h1 class=post-title><a href=https://blog.singasoong.top/posts/mongo_cluster_deployment/>高可用性的mongo集群搭建</a></h1><hr><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#mongodb安装>mongoDB安装</a><ul><li><a href=#配置yum管理包>配置yum管理包</a></li></ul></li><li><a href=#高可用性的mongo集群>高可用性的mongo集群</a><ul><li><a href=#三台服务器分配>三台服务器分配</a></li><li><a href=#启动config-server>启动Config server</a></li><li><a href=#启动shard-server分片服务>启动Shard server（分片服务）</a></li><li><a href=#启动mongos路由服务>启动mongos路由服务</a></li><li><a href=#整合配置路由分片服务器>整合配置、路由、分片服务器</a></li></ul></li></ul></nav></aside><hr><div class=post-content><h2 id=mongodb安装>mongoDB安装</h2><p>参照：<a href=https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/>https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/</a></p><h3 id=配置yum管理包>配置yum管理包</h3><p>在路径/etc/yum.repos.d/下创建文件mongodb-org-3.4.repo</p><pre tabindex=0><code class=language-repo data-lang=repo>[mongodb-org-3.4]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc
</code></pre><ul><li>安装mongo</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y mongodb-org
</span></span></code></pre></div><ul><li><p>mongo相关操作</p></li><li><p>创建用户</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongo       //启动Mongo shell命令
</span></span><span style=display:flex><span>use admin   //切换到admin数据库
</span></span><span style=display:flex><span>db.createUser<span style=color:#f92672>({</span>user:<span style=color:#e6db74>&#34;root&#34;</span>,pwd:<span style=color:#e6db74>&#34;123456&#34;</span>,roles:<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;root&#34;</span><span style=color:#f92672>]})</span>    //创建用户
</span></span><span style=display:flex><span>db.auth<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;root&#34;</span>,<span style=color:#e6db74>&#34;123456&#34;</span><span style=color:#f92672>)</span>    //验证用户创建是否成功
</span></span></code></pre></div><h2 id=高可用性的mongo集群>高可用性的mongo集群</h2><p>参照：<a href=http://www.lanceyan.com/tech/arch/mongodb_shard1.html>http://www.lanceyan.com/tech/arch/mongodb_shard1.html</a></p><h3 id=三台服务器分配>三台服务器分配</h3><p>按表格分别在各服务器进行目录创建：</p><ul><li>192.168.1.91</li></ul><table><thead><tr><th>服务</th><th>端口</th><th>日志路径</th><th>数据路径</th></tr></thead><tbody><tr><td>mongos</td><td>20001</td><td>mkdir -p /data/mongodbtest/mongos/log</td><td>&ndash;</td></tr><tr><td>Config server</td><td>21001</td><td>mkdir -p /data/mongodbtest/config/log</td><td>mkdir -p /data/mongodbtest/config/data</td></tr><tr><td>Shard server1主节点</td><td>22001</td><td>mkdir -p /data/mongodbtest/shard1/log</td><td>mkdir -p /data/mongodbtest/shard1/data</td></tr><tr><td>Shard server2副本</td><td>22002</td><td>mkdir -p /data/mongodbtest/shard2/log</td><td>mkdir -p /data/mongodbtest/shard2/data</td></tr><tr><td>Shard server3仲裁</td><td>22003</td><td>mkdir -p /data/mongodbtest/shard3/log</td><td>mkdir -p /data/mongodbtest/shard3/data</td></tr></tbody></table><ul><li>192.168.1.92</li></ul><table><thead><tr><th>服务</th><th>端口</th><th>日志路径</th><th>数据路径</th></tr></thead><tbody><tr><td>mongos</td><td>20001</td><td>mkdir -p /data/mongodbtest/mongos/log</td><td>&ndash;</td></tr><tr><td>Config server</td><td>21001</td><td>mkdir -p /data/mongodbtest/config/log</td><td>mkdir -p /data/mongodbtest/config/data</td></tr><tr><td>Shard server1仲裁</td><td>22001</td><td>mkdir -p /data/mongodbtest/shard1/log</td><td>mkdir -p /data/mongodbtest/shard1/data</td></tr><tr><td>Shard server2主节点</td><td>22002</td><td>mkdir -p /data/mongodbtest/shard2/log</td><td>mkdir -p /data/mongodbtest/shard2/data</td></tr><tr><td>Shard server3副本</td><td>22003</td><td>mkdir -p /data/mongodbtest/shard3/log</td><td>mkdir -p /data/mongodbtest/shard3/data</td></tr></tbody></table><ul><li>192.168.1.93</li></ul><table><thead><tr><th>服务</th><th>端口</th><th>日志路径</th><th>数据路径</th></tr></thead><tbody><tr><td>mongos</td><td>20001</td><td>mkdir -p /data/mongodbtest/mongos/log</td><td>&ndash;</td></tr><tr><td>Config server</td><td>21001</td><td>mkdir -p /data/mongodbtest/config/log</td><td>mkdir -p /data/mongodbtest/config/data</td></tr><tr><td>Shard server1副本</td><td>22001</td><td>mkdir -p /data/mongodbtest/shard1/log</td><td>mkdir -p /data/mongodbtest/shard1/data</td></tr><tr><td>Shard server2仲裁</td><td>22002</td><td>mkdir -p /data/mongodbtest/shard2/log</td><td>mkdir -p /data/mongodbtest/shard2/data</td></tr><tr><td>Shard server3主节点</td><td>22003</td><td>mkdir -p /data/mongodbtest/shard3/log</td><td>mkdir -p /data/mongodbtest/shard3/data</td></tr></tbody></table><h3 id=启动config-server>启动Config server</h3><ol><li><p>启动Config server</p><ul><li><p>分别配置三台config服务的配置文件，分别在对应config server的conf目录下(/data/mongodbtest/config/conf/)创建mongo_config.conf文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>dbPath</span>: <span style=color:#ae81ff>/data/mongodbtest/config/data</span>
</span></span><span style=display:flex><span><span style=color:#f92672>indexBuildRetry</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>systemLog</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>destination</span>: <span style=color:#ae81ff>file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>path</span>: <span style=color:#ae81ff>/data/mongodbtest/config/log/config.log</span>
</span></span><span style=display:flex><span><span style=color:#f92672>net</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>port</span>: <span style=color:#ae81ff>21001</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sharding</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>clusterRole</span>: <span style=color:#ae81ff>configsvr</span>
</span></span><span style=display:flex><span><span style=color:#f92672>replication</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>replSetName</span>: <span style=color:#ae81ff>docdetection</span>
</span></span><span style=display:flex><span><span style=color:#f92672>processManagement</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>fork</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div></li><li><p>通过配置文件分别启动config配置服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongod --config /data/mongodbtest/config/conf/mongo_config.conf
</span></span></code></pre></div></li></ul></li><li><p>初始化config复本集</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> <span style=color:#75715e>#设置config副本集，登录其中一个config服务器</span>
</span></span><span style=display:flex><span> /usr/bin/mongo  127.0.0.1:21001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>#使用admin数据库</span>
</span></span><span style=display:flex><span> use admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>#定义副本集配置</span>
</span></span><span style=display:flex><span> config <span style=color:#f92672>={</span>_id:<span style=color:#e6db74>&#39;docdetection&#39;</span>,members:<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>             <span style=color:#f92672>{</span>_id:0,host:<span style=color:#e6db74>&#39;192.168.1.91:21001&#39;</span>,priority:3<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>             <span style=color:#f92672>{</span>_id:1,host:<span style=color:#e6db74>&#39;192.168.1.92:21001&#39;</span>,priority:2<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>             <span style=color:#f92672>{</span>_id:2,host:<span style=color:#e6db74>&#39;192.168.1.93:21001&#39;</span>,priority:1<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>}</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>#初始化副本集配置</span>
</span></span><span style=display:flex><span> rs.initiate<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>#初始化结束（注意关闭各服务器防火墙）</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>{</span> <span style=color:#e6db74>&#34;ok&#34;</span> : <span style=color:#ae81ff>1</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>#查看状态</span>
</span></span><span style=display:flex><span>  rs.status<span style=color:#f92672>()</span>
</span></span></code></pre></div></li></ol><h3 id=启动shard-server分片服务>启动Shard server（分片服务）</h3><ol start=3><li><p>启动各分片服务</p><ul><li><p>分别到各服务器上各shard的conf目录下建文件mongo_config.conf。eg:192.168.1.91</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#75715e># shard1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>dbPath</span>: <span style=color:#ae81ff>/data/mongodbtest/shard1/data</span>
</span></span><span style=display:flex><span><span style=color:#f92672>indexBuildRetry</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>systemLog</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>destination</span>: <span style=color:#ae81ff>file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>path</span>: <span style=color:#ae81ff>/data/mongodbtest/shard1/log/shard1.log</span>
</span></span><span style=display:flex><span><span style=color:#f92672>net</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>port</span>: <span style=color:#ae81ff>22001</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sharding</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>clusterRole</span>: <span style=color:#ae81ff>shardsvr</span>
</span></span><span style=display:flex><span><span style=color:#f92672>replication</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>replSetName</span>: <span style=color:#ae81ff>shard1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>processManagement</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>fork</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># shard2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>dbPath</span>: <span style=color:#ae81ff>/data/mongodbtest/shard2/data</span>
</span></span><span style=display:flex><span><span style=color:#f92672>indexBuildRetry</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>systemLog</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>destination</span>: <span style=color:#ae81ff>file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>path</span>: <span style=color:#ae81ff>/data/mongodbtest/shard2/log/shard2.log</span>
</span></span><span style=display:flex><span><span style=color:#f92672>net</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>port</span>: <span style=color:#ae81ff>22002</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sharding</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>clusterRole</span>: <span style=color:#ae81ff>shardsvr</span>
</span></span><span style=display:flex><span><span style=color:#f92672>replication</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>replSetName</span>: <span style=color:#ae81ff>shard2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>processManagement</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>fork</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># shard3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>dbPath</span>: <span style=color:#ae81ff>/data/mongodbtest/shard3/data</span>
</span></span><span style=display:flex><span><span style=color:#f92672>indexBuildRetry</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>systemLog</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>destination</span>: <span style=color:#ae81ff>file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>path</span>: <span style=color:#ae81ff>/data/mongodbtest/shard3/log/shard3.log</span>
</span></span><span style=display:flex><span><span style=color:#f92672>net</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>port</span>: <span style=color:#ae81ff>22003</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sharding</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>clusterRole</span>: <span style=color:#ae81ff>shardsvr</span>
</span></span><span style=display:flex><span><span style=color:#f92672>replication</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>replSetName</span>: <span style=color:#ae81ff>shard3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>processManagement</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>fork</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div></li><li><p>通过配置文件分别启动shard分片服务(3*3=9个)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongod --config /data/mongodbtest/shard1/conf/mongo_config.conf
</span></span><span style=display:flex><span>mongod --config /data/mongodbtest/shard2/conf/mongo_config.conf
</span></span><span style=display:flex><span>mongod --config /data/mongodbtest/shard3/conf/mongo_config.conf
</span></span></code></pre></div></li></ul></li><li><p>初始化各分片服务器副本集</p></li></ol><p>设置第一个分片副本集:shard1（保证各副本已启动）<strong>注：priority 的值决定主（值大）从关系；arbiterOnly 指定仲裁节点</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#设置第一个分片副本集，登录其中一个分片服务器</span>
</span></span><span style=display:flex><span>/usr/bin/mongo  127.0.0.1:22001
</span></span><span style=display:flex><span><span style=color:#75715e>#使用admin数据库</span>
</span></span><span style=display:flex><span>use admin
</span></span><span style=display:flex><span><span style=color:#75715e>#定义副本集配置</span>
</span></span><span style=display:flex><span>config <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> _id:<span style=color:#e6db74>&#34;shard1&#34;</span>, members:<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:0,host:<span style=color:#e6db74>&#34;192.168.1.91:22001&#34;</span>,priority:2<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:1,host:<span style=color:#e6db74>&#34;192.168.1.92:22001&#34;</span>,arbiterOnly:true<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:2,host:<span style=color:#e6db74>&#34;192.168.1.93:22001&#34;</span>,priority:1<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#初始化副本集配置</span>
</span></span><span style=display:flex><span>rs.initiate<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span>;
</span></span></code></pre></div><p>设置第二个分片副本集：shard2</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#设置第二个分片副本集，登录其中一个分片服务器</span>
</span></span><span style=display:flex><span>/usr/bin/mongo  127.0.0.1:22002
</span></span><span style=display:flex><span><span style=color:#75715e>#使用admin数据库</span>
</span></span><span style=display:flex><span>use admin
</span></span><span style=display:flex><span><span style=color:#75715e>#定义副本集配置</span>
</span></span><span style=display:flex><span>config <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> _id:<span style=color:#e6db74>&#34;shard2&#34;</span>, members:<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:0,host:<span style=color:#e6db74>&#34;192.168.1.91:22002&#34;</span>,priority:1<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:1,host:<span style=color:#e6db74>&#34;192.168.1.92:22002&#34;</span>,priority:2<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:2,host:<span style=color:#e6db74>&#34;192.168.1.93:22002&#34;</span>,arbiterOnly:true<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#初始化副本集配置</span>
</span></span><span style=display:flex><span>rs.initiate<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span>;
</span></span></code></pre></div><p>设置第三个分片副本集：shard3</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#设置第三个分片副本集，登录其中一个分片服务器</span>
</span></span><span style=display:flex><span>/usr/bin/mongo  127.0.0.1:22003
</span></span><span style=display:flex><span><span style=color:#75715e>#使用admin数据库</span>
</span></span><span style=display:flex><span>use admin
</span></span><span style=display:flex><span><span style=color:#75715e>#定义副本集配置</span>
</span></span><span style=display:flex><span>config <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> _id:<span style=color:#e6db74>&#34;shard3&#34;</span>, members:<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:0,host:<span style=color:#e6db74>&#34;192.168.1.91:22003&#34;</span>,arbiterOnly:true<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:1,host:<span style=color:#e6db74>&#34;192.168.1.92:22003&#34;</span>,priority:1<span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>                  <span style=color:#f92672>{</span>_id:2,host:<span style=color:#e6db74>&#34;192.168.1.93:22003&#34;</span>,priority:2<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#初始化副本集配置</span>
</span></span><span style=display:flex><span>rs.initiate<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span>;
</span></span></code></pre></div><h3 id=启动mongos路由服务>启动mongos路由服务</h3><ul><li>配置mongos服务的配置文件，对应的conf目录下创建mongo_config.conf文件</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>systemLog</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>destination</span>: <span style=color:#ae81ff>file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>path</span>: <span style=color:#ae81ff>/data/mongodbtest/mongos/log/mongos.log</span>
</span></span><span style=display:flex><span><span style=color:#f92672>net</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>port</span>: <span style=color:#ae81ff>20001</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sharding</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>configDB</span>: <span style=color:#ae81ff>docdetection/192.168.1.91:21001,192.168.1.92:21001,192.168.1.93:21001</span>
</span></span><span style=display:flex><span><span style=color:#f92672>processManagement</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>fork</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><ul><li>通过配置文件分别启动config配置服务</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongos --config /data/mongodbtest/mongos/conf/mongo_config.conf
</span></span></code></pre></div><h3 id=整合配置路由分片服务器>整合配置、路由、分片服务器</h3><p>整合配置服务器、路由服务器，各个分片服务器</p><ol><li><p>整合配置、路由、分片服务器</p><ul><li><p>目前搭建了mongodb配置服务器、路由服务器，各个分片服务器，不过应用程序连接到 mongos 路由服务器并不能使用分片机制，还需要在程序里设置分片配置，让分片生效。<strong>分别连接三个mongos，添加分片副本集。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#设置分片配置，登录mongos路由服务器</span>
</span></span><span style=display:flex><span>/usr/bin/mongo 127.0.0.1:20001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#使用admin数据库</span>
</span></span><span style=display:flex><span>use admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#串联路由服务器与分片副本集1</span>
</span></span><span style=display:flex><span>sh.addShard<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;shard1/192.168.1.91:22001,192.168.1.92:22001,192.168.1.93:22001&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#串联路由服务器与分片副本集2</span>
</span></span><span style=display:flex><span>sh.addShard<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;shard2/192.168.1.91:22002,192.168.1.92:22002,192.168.1.93:22002&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#串联路由服务器与分片副本集3</span>
</span></span><span style=display:flex><span>sh.addShard<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;shard3/192.168.1.91:22003,192.168.1.92:22003,192.168.1.93:22003&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div></li></ul></li><li><p>添加创建用户</p><ul><li><p>集群管理员账号（mongos和配置服务器的集群管理员用户是可以通用的）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#以下是创建集群管理员用户步骤（连接其中一台Mongos服务上执行即可）</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#登录mongos路由服务器</span>
</span></span><span style=display:flex><span>/usr/bin/mongo 127.0.0.1:20001
</span></span><span style=display:flex><span><span style=color:#75715e>#使用admin数据库</span>
</span></span><span style=display:flex><span>use admin
</span></span><span style=display:flex><span><span style=color:#75715e>#创建账号及指定权限</span>
</span></span><span style=display:flex><span>db.createUser<span style=color:#f92672>({</span>
</span></span><span style=display:flex><span>  user: <span style=color:#e6db74>&#34;adminRoot&#34;</span>,
</span></span><span style=display:flex><span>  pwd: <span style=color:#e6db74>&#34;adminbear&#34;</span>,
</span></span><span style=display:flex><span>     roles: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>{</span> role: <span style=color:#e6db74>&#34;root&#34;</span>, db: <span style=color:#e6db74>&#34;admin&#34;</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>{</span> role: <span style=color:#e6db74>&#34;clusterAdmin&#34;</span>, db: <span style=color:#e6db74>&#34;admin&#34;</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>{</span> role: <span style=color:#e6db74>&#34;userAdmin&#34;</span>, db: <span style=color:#e6db74>&#34;admin&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>})</span>;
</span></span></code></pre></div></li><li><p>数据库用户</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#登录mongos路由服务器</span>
</span></span><span style=display:flex><span>/usr/bin/mongo 127.0.0.1:20001
</span></span><span style=display:flex><span><span style=color:#75715e>#以下是为数据库名mongoTest，创建数据库用户</span>
</span></span><span style=display:flex><span>use mongoTest;
</span></span><span style=display:flex><span>db.createUser<span style=color:#f92672>({</span>
</span></span><span style=display:flex><span>  user: <span style=color:#e6db74>&#34;mongoTestUser&#34;</span>,
</span></span><span style=display:flex><span>  pwd: <span style=color:#e6db74>&#34;bear&#34;</span>,
</span></span><span style=display:flex><span>  roles: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>{</span> role: <span style=color:#e6db74>&#34;readWrite&#34;</span>, db: <span style=color:#e6db74>&#34; mongoTest&#34;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>;
</span></span></code></pre></div><p>目前配置服务、路由服务、分片服务、副本集服务都已经串联起来了，但我们的目的是希望插入数据，数据能够自动分片。连接在mongos上，准备让指定的数据库、指定的集合分片生效。</p></li></ul></li><li><p>创建数据库，让指定数据库分片生效</p><ol><li><p>建库、表、指定应用分片的库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#登录mongos路由服务器</span>
</span></span><span style=display:flex><span>/usr/bin/mongo 127.0.0.1:20001
</span></span><span style=display:flex><span><span style=color:#75715e>#创建或者使用mongoTest数据库</span>
</span></span><span style=display:flex><span>use mongoTest;
</span></span><span style=display:flex><span><span style=color:#75715e>#创建mongoTest数据库中的集合</span>
</span></span><span style=display:flex><span>db.createCollection<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;table1&#34;</span><span style=color:#f92672>)</span>  <span style=color:#75715e>#新建集合：table1</span>
</span></span><span style=display:flex><span> ·
</span></span><span style=display:flex><span> ·
</span></span><span style=display:flex><span> ·
</span></span><span style=display:flex><span><span style=color:#75715e>#切换到admin数据库</span>
</span></span><span style=display:flex><span>use admin
</span></span><span style=display:flex><span><span style=color:#75715e>#指定testdb分片生效，mongoTest为数据库名称</span>
</span></span><span style=display:flex><span>db.runCommand<span style=color:#f92672>(</span> <span style=color:#f92672>{</span> enablesharding :<span style=color:#e6db74>&#34;mongoTest&#34;</span><span style=color:#f92672>})</span>;
</span></span></code></pre></div></li><li><p>指定分片的表。两种分片方式： Hashed Shard Key与Ranged Shard Key</p><ul><li><p>Hashed Shard Key：它采用字段的索引哈希值作为 shard key 的取值，这样做可以保证数据的均匀分布。在 mongos 和各个 shard 集群之间存在一个哈希值计算方法，所有的数据在迁移时都是根据这个方法来计算数据应当被迁移到什么地方。当 mongos 接收到一条语句时，通常他会把这条语句广播到所有的 shard 上去执行。</p></li><li><p>Ranged Shard Key: 根据 shard key 的取值，它把数据切分成连续的几个区间。取值相近的纪录会放进同一个 shard 服务器。好处是查询连续取值纪录时，查询效率可以得到保证。当数据库查询语句发送到 mongos 中时，mongos 会很快的找到目标 shard，而且不需要将语句发送到所有的 shard 上，一般只需要少量的 shard 就可以完成查询操作。缺点是不能保证数据的平均分配，在数据插入和修改时会产生比较严重的性能瓶颈</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#指定数据库里需要分片的集合和片键，table1为mongoTest数据库中集合名称</span>
</span></span><span style=display:flex><span>db.runCommand<span style=color:#f92672>({</span>shardcollection:<span style=color:#e6db74>&#34;mongoTest.table1&#34;</span>,key:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ZZJGDM&#34;</span>: <span style=color:#e6db74>&#34;hashed&#34;</span><span style=color:#f92672>}})</span> //Hashed Shard Key
</span></span><span style=display:flex><span>db.runCommand<span style=color:#f92672>({</span>shardcollection:<span style=color:#e6db74>&#34;mongoTest.table1&#34;</span>,key:<span style=color:#f92672>{</span>_id:1<span style=color:#f92672>}})</span>//    Ranged Shard Key
</span></span></code></pre></div></li></ul></li></ol></li></ol></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://blog.singasoong.top/tags/mongo%E9%9B%86%E7%BE%A4/>mongo集群</a></span>
<span class=tag><a href=https://blog.singasoong.top/tags/%E9%83%A8%E7%BD%B2/>部署</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2470 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2019-06-25 00:00</p></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://blog.singasoong.top/posts/git_usage/><span class=button__icon>←</span>
<span class=button__text>git使用</span></a></span>
<span class="button next"><a href=https://blog.singasoong.top/posts/linux/><span class=button__text>linux的一些零星记录</span>
<span class=button__icon>→</span></a></span></div></div><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script>const gitalk=new Gitalk({clientID:"124ff39b628505f4d977",clientSecret:"d199d6467a5da21b8b15f71edc7d02c7cc38e2f1",repo:"hesoong.github.io",owner:"hesoong",admin:["hesoong"],id:location.pathname,distractionFreeMode:!1});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>Copyright &copy; 2025</span>
<span><a href=https://blog.singasoong.top/>Song</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Theme made with <a href=https://atlialp.com/>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.205d491810c28f95aa953fae884e1c27abe13fdf93ec63b882d0036b248d4a6282eb2d134e4e7225c6ad6e86db87b08488a361ca4a7383d01fcff43f3d57b9c3.js integrity="sha512-IF1JGBDCj5WqlT+uiE4cJ6vhP9+T7GO4gtADaySNSmKC6y0TTk5yJcatbobbh7CEiKNhykpzg9Afz/Q/PVe5ww=="></script>
<script src=/js/anchorforid.js></script>
<script src=/js/main.js></script></body></html>